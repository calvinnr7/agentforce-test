<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Agentforce Test ‚Äì GitHub Pages</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0,interactive-widget=overlays-content"/> <!--INCLUDE ON DEPLOYMENT -->
  
  <meta name="robots" content="noindex,nofollow" />
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self' https: data: blob:;
             script-src 'self' https: 'unsafe-inline' 'unsafe-eval';
             connect-src 'self' https: wss:;
             img-src 'self' https: data: blob:;
             style-src 'self' 'unsafe-inline' https:;
             frame-src https:;
             font-src 'self' https: data:;">
<style>
  :root{
    --brand-green-light: #bfeee1;  /* very light mint */
    --brand-green:       #0AA373;  /* your brand green */
    --brand-green-dark:  #0A855F;  /* deeper green */
  }

  body{
    margin:0;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;

    /* Top ‚Üí bottom linear gradient (light to dark) */
    background: linear-gradient(
      180deg,
      var(--brand-green-light) 0%,
      var(--brand-green) 45%,
      var(--brand-green-dark) 100%
    );
  }

  .card{
    background:#fff;
    border-radius:16px;
    padding:24px;
    max-width:760px; width:90%;
    box-shadow:0 12px 28px rgba(0,0,0,.25);
    color:#111;
  }

  /* include in deployment start */

	/* Fix double scroll issue */
	.embeddedMessagingLiveRegion {
		height: 0 !important;
	}
</style>

</head>
<body>
  <div class="card">
    <h1>Agentforce (MIAW) ‚Äì Test Page Munawir B</h1>
    <p class="muted">Hosted on GitHub Pages. Not indexed. Use for safe agent testing.</p>
    <p>
      <button onclick="openChat()">Open Chat</button>
      <button onclick="location.reload()">Hard Refresh</button>
    </p>
    <pre id="log" class="muted"></pre>
  </div>

  <script>
  // Helper: read query param
  function getParam(name) {
    return new URLSearchParams(window.location.search).get(name);
  }

	// Fix Viewport Meta on Android
  	document.addEventListener('DOMContentLoaded', () => {
    
    // 1. Find the viewport meta tag in the document's <head>
    const metaViewport = document.querySelector('meta[name="viewport"]');

    // Safety check: if the tag doesn't exist, do nothing.
    if (!metaViewport) {
      console.warn('Bootstrap override: Viewport meta tag not found.');
      return;
    }

    // 2. Define the exact value the Salesforce script sets...
    const undesiredContent = 'width=device-width, initial-scale=1, minimum-scale=1, interactive-widget=resizes-content';
    
    // ...and the value you want to enforce instead.
    const desiredContent = 'width=device-width, initial-scale=1, minimum-scale-1, interactive-widget=resizes-visual';

    // 3. Create an observer to watch for changes to the meta tag
    const observer = new MutationObserver((mutationsList) => {
      // Loop through any changes that were detected
      for (const mutation of mutationsList) {
        // We only care about changes to the 'content' attribute
        if (mutation.type === 'attributes' && mutation.attributeName === 'content') {
          
          // 4. Check if the new value is the one we want to replace
          if (metaViewport.getAttribute('content') === undesiredContent) {
            
            // 5. If it is, immediately set it to your desired value
            metaViewport.setAttribute('content', desiredContent);
          }
        }
      }
    });

    // 6. Tell the observer to start watching the meta tag for attribute changes
    observer.observe(metaViewport, { attributes: true });

  });

  // Register the listener BEFORE bootstrap loads, so we never miss the event
  window.addEventListener("onEmbeddedMessagingReady", () => {
    console.log("‚ö° onEmbeddedMessagingReady fired");
	  console.log('localStorage',console.log(localStorage.getItem('00DOg000001Vluv_WEB_STORAGE')));

    const QUERY_KEYS = {
      plan: "pid"
    };

    const DEFAULT_PLAN_CODE = "p"; // Default plan if PID not passed

    // Fetch the pid if sent in the CTA URL or use the Default
    
    const planCode = getParam(QUERY_KEYS.plan) || DEFAULT_PLAN_CODE;
    
    if (planCode) {
      embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields({
        // must match the Channel Variable Name you defined in Messaging Setup
        "recommendedPlanCode": planCode
      });
      console.log("üîí setHiddenPrechatFields: recommendedPlanCode =", planCode);

      // optional: inspect what‚Äôs queued
      console.log("üëÄ getPrechatFields() ‚Üí", embeddedservice_bootstrap.prechatAPI.getPrechatFields?.());
    } else {
      console.log("‚ÑπÔ∏è No recommendedPlanCode in URL");
    }
  });


window.addEventListener("onEmbeddedMessageSent", (event) => {
	console.log(event.detail);
  // 1. Check if the event detail and sender property exist, and if the sender is the EndUser.
  if (event.detail?.conversationEntry?.sender.role === 'EndUser') {
    console.log("Message from EndUser detected. Preparing to call API.");

    // 2. Safely get the required data
    const conversationId = event.detail.conversationId;
    const storageItem = localStorage.getItem('00DOg000001Vluv_WEB_STORAGE');
    
    // We must parse the string from localStorage to access its properties
    const accessToken = storageItem ? JSON.parse(storageItem).JWT : null;

    // Exit if we don't have the necessary data
    if (!conversationId || !accessToken) {
      console.error("Missing conversationId or accessToken. Aborting API call.");
      return;
    }

    // 3. Define API endpoint and request body
    const apiUrl = 'https://onz--dcaidev.sandbox.my.site.com/ESWMRIMessagingUI1758773345576vforcesite/services/apexrest/MessagingSessionUpdater/';
    const requestBody = {
      conversationId: conversationId,
      accessToken: accessToken
    };

    // 4. Make the POST request using fetch
    fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestBody) // Body must be a JSON string
    })
    .then(response => {
      // 5. Check if the request was successful
      if (!response.ok) {
        // Throw an error to be caught by the .catch() block
        throw new Error(`API call failed with status: ${response.status}`);
      }
      // Continue the promise chain by returning the parsed JSON
      return response.json();
    })
    .then(result => {
      // This block runs only if the API call was successful and JSON was parsed
      console.log("‚úÖ API call successful! Response:", result);
    })
    .catch(error => {
      // This block runs if any part of the fetch or .then() chain fails
      console.error("‚ùå An error occurred during the API call:", error);
    });
  }
});
	  

  // Init called when bootstrap loads
  function initEmbeddedMessaging() {
    try {
      console.log("‚Üí initEmbeddedMessaging()");
      embeddedservice_bootstrap.settings.language = "en_US";
      embeddedservice_bootstrap.settings.enableUserInputForConversationWithBot = false;
      embeddedservice_bootstrap.settings.disableStreamingResponses = true;

      embeddedservice_bootstrap.init(
        '00DOg000001Vluv',
		'MRI_Messaging_UI',
		'https://onz--dcaidev.sandbox.my.site.com/ESWMRIMessagingUI1758773345576',
		{
			scrt2URL: 'https://onz--dcaidev.sandbox.my.salesforce-scrt.com'
		}
      );
      console.log("‚úÖ init() called");
    } catch (err) {
      console.error("‚ùå init error:", err);
    }
  }

  // Button handler
function openChat() {
  if (embeddedservice_bootstrap?.utilAPI?.launchChat) {
    embeddedservice_bootstrap.utilAPI.launchChat()
      .then(() => console.log("üü¢ launchChat() invoked"))
      .catch(err => console.error("‚ùå launchChat() error:", err));
  } else {
    console.log("‚è≥ utilAPI not ready yet");
  }
}
</script>

<script type='text/javascript' src='https://onz--dcaidev.sandbox.my.site.com/ESWMRIMessagingUI1758773345576/assets/js/bootstrap.min.js' onload='initEmbeddedMessaging()'></script>

</body>
</html>
