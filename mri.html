<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Agentforce Test ‚Äì GitHub Pages MRI 2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0/> <!--INCLUDE ON DEPLOYMENT -->
  
  <meta name="robots" content="noindex,nofollow" />
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self' https: data: blob:;
             script-src 'self' https: 'unsafe-inline' 'unsafe-eval';
             connect-src 'self' https: wss:;
             img-src 'self' https: data: blob:;
             style-src 'self' 'unsafe-inline' https:;
             frame-src https:;
             font-src 'self' https: data:;">
<style>
  :root{
    --brand-green-light: #bfeee1;  /* very light mint */
    --brand-green:       #0AA373;  /* your brand green */
    --brand-green-dark:  #0A855F;  /* deeper green */
  }

  body{
    margin:0;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;

    /* Top ‚Üí bottom linear gradient (light to dark) */
    background: linear-gradient(
      180deg,
      var(--brand-green-light) 0%,
      var(--brand-green) 45%,
      var(--brand-green-dark) 100%
    );
  }

  .card{
    background:#fff;
    border-radius:16px;
    padding:24px;
    max-width:760px; width:90%;
    box-shadow:0 12px 28px rgba(0,0,0,.25);
    color:#111;
  }

	/* include in deployment start */
	
	/* Fix Keyboard resize window for Android */
	.embeddedMessagingFrame {
		min-height: 480px !important;
	}

	/* Fix double scroll issue */
	.embeddedMessagingLiveRegion {
		height: 0 !important;
	}

	/* include in deployment end */

	
	
</style>

</head>
<body>
  <div class="card">
    <h1>Agentforce (MIAW) ‚Äì Test Page munawir</h1>
    <p class="muted">Hosted on GitHub Pages. Not indexed. Use for safe agent testing.</p>
    <p>
      <button onclick="openChat()">Open Chat</button>
      <button onclick="location.reload()">Hard Refresh</button>
    </p>
    <pre id="log" class="muted"></pre>
  </div>

<script>
  // Helper: read query param
  function getParam(name) {
    return new URLSearchParams(window.location.search).get(name);
  }

	window.addEventListener("onEmbeddedMessageSent", () => {
		const resetTimeout = new CustomEvent('resetTimeout', {
			  detail: {
			    status: 'Success',
			  }
			});
		console.log('resetTimeout',resetTimeout);
		window.dispatchEvent(resetTimeout);
	});
	
  // Register the listener BEFORE bootstrap loads, so we never miss the event
  window.addEventListener("onEmbeddedMessagingReady", () => {
    console.log("‚ö° onEmbeddedMessagingReady fired");

    const QUERY_KEYS = {
      plan: "pid"
    };

    const DEFAULT_PLAN_CODE = "p"; // Default plan if PID not passed

    // Fetch the pid if sent in the CTA URL or use the Default
    
    const planCode = getParam(QUERY_KEYS.plan) || DEFAULT_PLAN_CODE;
    
    if (planCode) {
      embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields({
        // must match the Channel Variable Name you defined in Messaging Setup
        "recommendedPlanCode": planCode
      });
      console.log("üîí setHiddenPrechatFields: recommendedPlanCode =", planCode);

      // optional: inspect what's queued
      console.log("üëÄ getPrechatFields() ‚Üí", embeddedservice_bootstrap.prechatAPI.getPrechatFields?.());
    } else {
      console.log("‚ÑπÔ∏è No recommendedPlanCode in URL");
    }
  });

	// ===================================================================
    // == NEWLY ADDED CODE STARTS HERE ===================================
    // ===================================================================
    // FIX: Workaround to hide keyboard on Android after a bot message
    const isAndroid = /Android/i.test(navigator.userAgent);
    if (isAndroid) {
      window.addEventListener("onEmbeddedMessageSent", (event) => {
		  event.preventDefault();
          setTimeout(() => {
            const activeElement = document.activeElement;
            if (activeElement && activeElement.blur) {
              activeElement.blur();
            }
          }, 150);
      });
    }
    // ===================================================================
    // == NEWLY ADDED CODE ENDS HERE =====================================
    // ===================================================================

  // Init called when bootstrap loads
  function initEmbeddedMessaging() {
    try {
      console.log("‚Üí initEmbeddedMessaging()");
      embeddedservice_bootstrap.settings.language = "en_US";
      embeddedservice_bootstrap.settings.enableUserInputForConversationWithBot = false;
      embeddedservice_bootstrap.settings.disableStreamingResponses = true;

      embeddedservice_bootstrap.init(
        '00DOg000001Vluv',
				'MRI_Messaging_UI',
				'https://onz--dcaidev.sandbox.my.site.com/ESWMRIMessagingUI1758773345576',
				{
					scrt2URL: 'https://onz--dcaidev.sandbox.my.salesforce-scrt.com'
				}
			);
      console.log("‚úÖ init() called");
    } catch (err) {
      console.error("‚ùå init error:", err);
    }
  }

  // Button handler
  function openChat() {
    if (embeddedservice_bootstrap?.utilAPI?.launchChat) {
      embeddedservice_bootstrap.utilAPI.launchChat()
        .then(() => console.log("üü¢ launchChat() invoked"))
        .catch(err => console.error("‚ùå launchChat() error:", err));
    } else {
      console.log("‚è≥ utilAPI not ready yet");
    }
  }
</script>

<script type='text/javascript' src='https://calvinnr7.github.io/agentforce-test/bootstrap.js' onload='initEmbeddedMessaging()'></script>

</body>
</html>
